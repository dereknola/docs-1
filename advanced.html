<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-advanced/advanced">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Advanced Options / Configuration | K3s</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.k3s.io/docs-k3s/advanced"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Advanced Options / Configuration | K3s"><meta data-rh="true" name="description" content="This section contains advanced information describing the different ways you can run and manage K3s, as well as steps necessary to prepare the host OS for K3s use."><meta data-rh="true" property="og:description" content="This section contains advanced information describing the different ways you can run and manage K3s, as well as steps necessary to prepare the host OS for K3s use."><link data-rh="true" rel="icon" href="/docs-k3s/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.k3s.io/docs-k3s/advanced"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/docs-k3s/advanced" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/docs-k3s/zh/advanced" hreflang="zh"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/docs-k3s/kr/advanced" hreflang="kr"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/docs-k3s/advanced" hreflang="x-default"><link rel="stylesheet" href="/docs-k3s/assets/css/styles.1da039b9.css">
<link rel="preload" href="/docs-k3s/assets/js/runtime~main.e1810fa2.js" as="script">
<link rel="preload" href="/docs-k3s/assets/js/main.3e014df7.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs-k3s/"><div class="navbar__logo"><img src="/docs-k3s/img/k3s-logo-light.svg" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs-k3s/img/k3s-logo-dark.svg" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs-k3s/advanced" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/docs-k3s/zh/advanced" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh">简体中文</a></li><li><a href="/docs-k3s/kr/advanced" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="kr">한국어</a></li></ul></div><a href="https://github.com/k3s-io/k3s/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn">GitHub</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-k3s/">K3s - Lightweight Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-k3s/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-k3s/quick-start">Quick-Start Guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-k3s/installation">Installation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Installation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-k3s/datastore">Cluster Datastore</a><button aria-label="Toggle the collapsible sidebar category &#x27;Cluster Datastore&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-k3s/cluster-access">Cluster Access</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-k3s/upgrades">Upgrades</a><button aria-label="Toggle the collapsible sidebar category &#x27;Upgrades&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-k3s/storage">Volumes and Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-k3s/networking">Networking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-k3s/helm">Helm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs-k3s/advanced">Advanced Options / Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-k3s/faq">FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-k3s/cli">CLI Tools</a><button aria-label="Toggle the collapsible sidebar category &#x27;CLI Tools&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-k3s/reference">Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs-k3s/release-notes/v1.24.X">Release Notes</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-k3s/known-issues">Known Issues</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-k3s/security">Security</a><button aria-label="Toggle the collapsible sidebar category &#x27;Security&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs-k3s/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Advanced Options / Configuration</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Advanced Options / Configuration</h1></header><p>This section contains advanced information describing the different ways you can run and manage K3s, as well as steps necessary to prepare the host OS for K3s use.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="certificate-management">Certificate Management<a href="#certificate-management" class="hash-link" aria-label="Direct link to Certificate Management" title="Direct link to Certificate Management">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="certificate-authority-certificates">Certificate Authority Certificates<a href="#certificate-authority-certificates" class="hash-link" aria-label="Direct link to Certificate Authority Certificates" title="Direct link to Certificate Authority Certificates">​</a></h3><p>K3s generates self-signed Certificate Authority (CA) Certificates during startup of the first server node. These CA certificates are valid for 10 years, and are not automatically renewed.</p><p>For information on using custom CA certificates, or renewing the self-signed CA certificates, see the <a href="/docs-k3s/cli/certificate#certificate-authority-ca-certificates"><code>k3s certificate rotate-ca</code> command documentation</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="client-and-server-certificates">Client and Server certificates<a href="#client-and-server-certificates" class="hash-link" aria-label="Direct link to Client and Server certificates" title="Direct link to Client and Server certificates">​</a></h3><p>K3s client and server certificates are valid for 365 days from their date of issuance. Any certificates that are expired, or within 90 days of expiring, are automatically renewed every time K3s starts.</p><p>For information on manually rotating client and server certificates, see the <a href="/docs-k3s/cli/certificate#client-and-server-certificates"><code>k3s certificate rotate</code> command documentation</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="token-management">Token Management<a href="#token-management" class="hash-link" aria-label="Direct link to Token Management" title="Direct link to Token Management">​</a></h2><p>By default, K3s uses a single static token for both servers and agents. This token cannot be changed once the cluster has been created.
It is possible to enable a second static token that can only be used to join agents, or to create temporary <code>kubeadm</code> style join tokens that expire automatically.
For more information, see the <a href="/docs-k3s/cli/token"><code>k3s token</code> command documentation</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-an-http-proxy">Configuring an HTTP proxy<a href="#configuring-an-http-proxy" class="hash-link" aria-label="Direct link to Configuring an HTTP proxy" title="Direct link to Configuring an HTTP proxy">​</a></h2><p>If you are running K3s in an environment, which only has external connectivity through an HTTP proxy, you can configure your proxy settings on the K3s systemd service. These proxy settings will then be used in K3s and passed down to the embedded containerd and kubelet.</p><p>The K3s installation script will automatically take the <code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code> and <code>NO_PROXY</code>, as well as the <code>CONTAINERD_HTTP_PROXY</code>, <code>CONTAINERD_HTTPS_PROXY</code> and <code>CONTAINERD_NO_PROXY</code> variables from the current shell, if they are present, and write them to the environment file of your systemd service, usually:</p><ul><li><code>/etc/systemd/system/k3s.service.env</code></li><li><code>/etc/systemd/system/k3s-agent.service.env</code></li></ul><p>Of course, you can also configure the proxy by editing these files.</p><p>K3s will automatically add the cluster internal Pod and Service IP ranges and cluster DNS domain to the list of <code>NO_PROXY</code> entries. You should ensure that the IP address ranges used by the Kubernetes nodes themselves (i.e. the public and private IPs of the nodes) are included in the <code>NO_PROXY</code> list, or that the nodes can be reached through the proxy.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTPS_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NO_PROXY=127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you want to configure the proxy settings for containerd without affecting K3s and the Kubelet, you can prefix the variables with <code>CONTAINERD_</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINERD_HTTP_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINERD_HTTPS_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINERD_NO_PROXY=127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-docker-as-the-container-runtime">Using Docker as the Container Runtime<a href="#using-docker-as-the-container-runtime" class="hash-link" aria-label="Direct link to Using Docker as the Container Runtime" title="Direct link to Using Docker as the Container Runtime">​</a></h2><p>K3s includes and defaults to <a href="https://containerd.io/" target="_blank" rel="noopener noreferrer">containerd</a>, an industry-standard container runtime.
As of Kubernetes 1.24, the Kubelet no longer includes dockershim, the component that allows the kubelet to communicate with dockerd.
K3s 1.24 and higher include <a href="https://github.com/Mirantis/cri-dockerd" target="_blank" rel="noopener noreferrer">cri-dockerd</a>, which allows seamless upgrade from prior releases of K3s while continuing to use the Docker container runtime.</p><p>To use Docker instead of containerd:</p><ol><li><p>Install Docker on the K3s node. One of Rancher&#x27;s <a href="https://github.com/rancher/install-docker" target="_blank" rel="noopener noreferrer">Docker installation scripts</a> can be used to install Docker:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> https://releases.rancher.com/install-docker/20.10.sh </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Install K3s using the <code>--docker</code> option:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> -sfL https://get.k3s.io </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sh</span><span class="token plain"> -s - --docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Confirm that the cluster is available:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> k3s kubectl get pods --all-namespaces</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NAMESPACE     NAME                                     READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   local-path-provisioner-6d59f47c7-lncxn   </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   metrics-server-7566d596c8-9tnck          </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   helm-install-traefik-mbkn9               </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">/1     Completed   </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   coredns-8655855d6-rtbnb                  </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   svclb-traefik-jbmvl                      </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain">/2     Running     </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          43s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   traefik-758cd5fc85-2wz97                 </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          43s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Confirm that the Docker containers are running:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">ps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINER ID        IMAGE                     COMMAND                  CREATED              STATUS              PORTS               NAMES</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3e4d34729602        897ce3c5fc8f              </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;entry&quot;</span><span class="token plain">                  About a minute ago   Up About a minute                       k8s_lb-port-443_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bffdc9d7a65f        rancher/klipper-lb        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;entry&quot;</span><span class="token plain">                  About a minute ago   Up About a minute                       k8s_lb-port-80_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">436b85c5e38d        rancher/library-traefik   </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/traefik --configfi…&quot;</span><span class="token plain">   About a minute ago   Up About a minute                       k8s_traefik_traefik-758cd5fc85-2wz97_kube-system_07abe831-ffd6-4206-bfa1-7c9ca4fb39e7_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">de8fded06188        rancher/pause:3.1         </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/pause&quot;</span><span class="token plain">                 About a minute ago   Up About a minute                       k8s_POD_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">7c6a30aeeb2f        rancher/pause:3.1         </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/pause&quot;</span><span class="token plain">                 About a minute ago   Up About a minute                       k8s_POD_traefik-758cd5fc85-2wz97_kube-system_07abe831-ffd6-4206-bfa1-7c9ca4fb39e7_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ae6c58cab4a7        9d12f9848b99              </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;local-path-provisio…&quot;</span><span class="token plain">   About a minute ago   Up About a minute                       k8s_local-path-provisioner_local-path-provisioner-6d59f47c7-lncxn_kube-system_2dbd22bf-6ad9-4bea-a73d-620c90a6c1c1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">be1450e1a11e        9dd718864ce6              </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/metrics-server&quot;</span><span class="token plain">        About a minute ago   Up About a minute                       k8s_metrics-server_metrics-server-7566d596c8-9tnck_kube-system_031e74b5-e9ef-47ef-a88d-fbf3f726cbc6_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4454d14e4d3f        c4d3d16fe508              </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/coredns -conf /etc…&quot;</span><span class="token plain">   About a minute ago   Up About a minute                       k8s_coredns_coredns-8655855d6-rtbnb_kube-system_d05725df-4fb1-410a-8e82-2b1c8278a6a1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">c3675b87f96c        rancher/pause:3.1         </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/pause&quot;</span><span class="token plain">                 About a minute ago   Up About a minute                       k8s_POD_coredns-8655855d6-rtbnb_kube-system_d05725df-4fb1-410a-8e82-2b1c8278a6a1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4b1fddbe6ca6        rancher/pause:3.1         </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/pause&quot;</span><span class="token plain">                 About a minute ago   Up About a minute                       k8s_POD_local-path-provisioner-6d59f47c7-lncxn_kube-system_2dbd22bf-6ad9-4bea-a73d-620c90a6c1c1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">64d3517d4a95        rancher/pause:3.1         </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/pause&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-etcdctl">Using etcdctl<a href="#using-etcdctl" class="hash-link" aria-label="Direct link to Using etcdctl" title="Direct link to Using etcdctl">​</a></h2><p>etcdctl provides a CLI for interacting with etcd servers. K3s does not bundle etcdctl.</p><p>If you would like to use etcdctl to interact with K3s&#x27;s embedded etcd, install etcdctl using the <a href="https://etcd.io/docs/latest/install/" target="_blank" rel="noopener noreferrer">official documentation</a>.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token assign-left variable" style="color:rgb(191, 199, 213)">ETCD_VERSION</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;v3.5.5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">ETCD_URL</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;https://github.com/etcd-io/etcd/releases/download/</span><span class="token string variable" style="color:rgb(191, 199, 213)">${ETCD_VERSION}</span><span class="token string" style="color:rgb(195, 232, 141)">/etcd-</span><span class="token string variable" style="color:rgb(191, 199, 213)">${ETCD_VERSION}</span><span class="token string" style="color:rgb(195, 232, 141)">-linux-amd64.tar.gz&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> -sL </span><span class="token variable" style="color:rgb(191, 199, 213)">${ETCD_URL}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tar</span><span class="token plain"> -zxv --strip-components</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> -C /usr/local/bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You may then use etcdctl by configuring it to use the K3s-managed certificates and keys for authentication:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> etcdctl version </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --cacert</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --cert</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">/var/lib/rancher/k3s/server/tls/etcd/client.crt </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --key</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">/var/lib/rancher/k3s/server/tls/etcd/client.key</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-containerd">Configuring containerd<a href="#configuring-containerd" class="hash-link" aria-label="Direct link to Configuring containerd" title="Direct link to Configuring containerd">​</a></h2><p>K3s will generate config.toml for containerd in <code>/var/lib/rancher/k3s/agent/etc/containerd/config.toml</code>.</p><p>For advanced customization for this file you can create another file called <code>config.toml.tmpl</code> in the same directory, and it will be used instead.</p><p>The <code>config.toml.tmpl</code> will be treated as a Go template file, and the <code>config.Node</code> structure is being passed to the template. See <a href="https://github.com/k3s-io/k3s/blob/master/pkg/agent/templates" target="_blank" rel="noopener noreferrer">this folder</a> for Linux and Windows examples on how to use the structure to customize the configuration file.
The config.Node golang struct is defined <a href="https://github.com/k3s-io/k3s/blob/master/pkg/daemons/config/types.go#L37" target="_blank" rel="noopener noreferrer">here</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nvidia-container-runtime-support">NVIDIA Container Runtime Support<a href="#nvidia-container-runtime-support" class="hash-link" aria-label="Direct link to NVIDIA Container Runtime Support" title="Direct link to NVIDIA Container Runtime Support">​</a></h2><p>K3s will automatically detect and configure the NVIDIA container runtime if it is present when K3s starts.</p><ol><li>Install the nvidia-container package repository on the node by following the instructions at:
<a href="https://nvidia.github.io/libnvidia-container/" target="_blank" rel="noopener noreferrer">https://nvidia.github.io/libnvidia-container/</a></li><li>Install the nvidia container runtime packages. For example:
<code>apt install -y nvidia-container-runtime cuda-drivers-fabricmanager-515 nvidia-headless-515-server</code></li><li>Install K3s, or restart it if already installed:
<code>curl -ksL get.k3s.io | sh -</code></li><li>Confirm that the nvidia container runtime has been found by k3s:
<code>grep nvidia /var/lib/rancher/k3s/agent/etc/containerd/config.toml</code></li></ol><p>This will automatically add <code>nvidia</code> and/or <code>nvidia-experimental</code> runtimes to the containerd configuration, depending on what runtime executables are found.
You must still add a RuntimeClass definition to your cluster, and deploy Pods that explicitly request the appropriate runtime by setting <code>runtimeClassName: nvidia</code> in the Pod spec:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> node.k8s.io/v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> RuntimeClass</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nbody</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">gpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">benchmark</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> OnFailure</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">runtimeClassName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cuda</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvcr.io/nvidia/k8s/cuda</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">sample</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">nbody</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;nbody&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-gpu&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-benchmark&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> NVIDIA_VISIBLE_DEVICES</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> all</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> NVIDIA_DRIVER_CAPABILITIES</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that the NVIDIA Container Runtime is also frequently used with the <a href="https://github.com/NVIDIA/k8s-device-plugin/" target="_blank" rel="noopener noreferrer">NVIDIA Device Plugin</a> and <a href="https://github.com/NVIDIA/gpu-feature-discovery/" target="_blank" rel="noopener noreferrer">GPU Feature Discovery</a>, which must be installed separately, with modifications to ensure that pod specs include <code>runtimeClassName: nvidia</code>, as mentioned above.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-agentless-servers-experimental">Running Agentless Servers (Experimental)<a href="#running-agentless-servers-experimental" class="hash-link" aria-label="Direct link to Running Agentless Servers (Experimental)" title="Direct link to Running Agentless Servers (Experimental)">​</a></h2><blockquote><p><strong>Warning:</strong> This feature is experimental.</p></blockquote><p>When started with the <code>--disable-agent</code> flag, servers do not run the kubelet, container runtime, or CNI. They do not register a Node resource in the cluster, and will not appear in <code>kubectl get nodes</code> output.
Because they do not host a kubelet, they cannot run pods or be managed by operators that rely on enumerating cluster nodes, including the embedded etcd controller and the system upgrade controller.</p><p>Running agentless servers may be advantageous if you want to obscure your control-plane nodes from discovery by agents and workloads, at the cost of increased administrative overhead caused by lack of cluster operator support.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-rootless-servers-experimental">Running Rootless Servers (Experimental)<a href="#running-rootless-servers-experimental" class="hash-link" aria-label="Direct link to Running Rootless Servers (Experimental)" title="Direct link to Running Rootless Servers (Experimental)">​</a></h2><blockquote><p><strong>Warning:</strong> This feature is experimental.</p></blockquote><p>Rootless mode allows running K3s servers as an unprivileged user, so as to protect the real root on the host from potential container-breakout attacks.</p><p>See <a href="https://rootlesscontaine.rs/" target="_blank" rel="noopener noreferrer">https://rootlesscontaine.rs/</a> to learn more about Rootless Kubernetes.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="known-issues-with-rootless-mode">Known Issues with Rootless mode<a href="#known-issues-with-rootless-mode" class="hash-link" aria-label="Direct link to Known Issues with Rootless mode" title="Direct link to Known Issues with Rootless mode">​</a></h3><ul><li><p><strong>Ports</strong></p><p>When running rootless a new network namespace is created.  This means that K3s instance is running with networking fairly detached from the host.
The only way to access Services run in K3s from the host is to set up port forwards to the K3s network namespace.
Rootless K3s includes controller that will automatically bind 6443 and service ports below 1024 to the host with an offset of 10000.</p><p>For example, a Service on port 80 will become 10080 on the host, but 8080 will become 8080 without any offset. Currently, only LoadBalancer Services are automatically bound.</p></li><li><p><strong>Cgroups</strong></p><p>Cgroup v1 and Hybrid v1/v2 are not supported; only pure Cgroup v2 is supported. If K3s fails to start due to missing cgroups when running rootless, it is likely that your node is in Hybrid mode, and the &quot;missing&quot; cgroups are still bound to a v1 controller.</p></li><li><p><strong>Multi-node/multi-process cluster</strong></p><p>Multi-node rootless clusters, or multiple rootless k3s processes on the same node, are not currently supported. See <a href="https://github.com/k3s-io/k3s/issues/6488#issuecomment-1314998091" target="_blank" rel="noopener noreferrer">#6488</a> for more details.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="starting-rootless-servers">Starting Rootless Servers<a href="#starting-rootless-servers" class="hash-link" aria-label="Direct link to Starting Rootless Servers" title="Direct link to Starting Rootless Servers">​</a></h3><ul><li><p>Enable cgroup v2 delegation, see <a href="https://rootlesscontaine.rs/getting-started/common/cgroup2/" target="_blank" rel="noopener noreferrer">https://rootlesscontaine.rs/getting-started/common/cgroup2/</a> .
This step is required; the rootless kubelet will fail to start without the proper cgroups delegated.</p></li><li><p>Download <code>k3s-rootless.service</code> from <a href="https://github.com/k3s-io/k3s/blob/master/k3s-rootless.service" target="_blank" rel="noopener noreferrer"><code>https://github.com/k3s-io/k3s/blob/&lt;VERSION&gt;/k3s-rootless.service</code></a>.
Make sure to use the same version of <code>k3s-rootless.service</code> and <code>k3s</code>.</p></li><li><p>Install <code>k3s-rootless.service</code> to <code>~/.config/systemd/user/k3s-rootless.service</code>.
Installing this file as a system-wide service (<code>/etc/systemd/...</code>) is not supported.
Depending on the path of <code>k3s</code> binary, you might need to modify the <code>ExecStart=/usr/local/bin/k3s ...</code> line of the file.</p></li><li><p>Run <code>systemctl --user daemon-reload</code></p></li><li><p>Run <code>systemctl --user enable --now k3s-rootless</code></p></li><li><p>Run <code>KUBECONFIG=~/.kube/k3s.yaml kubectl get pods -A</code>, and make sure the pods are running.</p></li></ul><blockquote><p><strong>Note:</strong> Don&#x27;t try to run <code>k3s server --rootless</code> on a terminal, as terminal sessions do not allow cgroup v2 delegation.
If you really need to try it on a terminal, use <code>systemd-run --user -p Delegate=yes --tty k3s server --rooless</code> to wrap it in a systemd scope.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="advanced-rootless-configuration">Advanced Rootless Configuration<a href="#advanced-rootless-configuration" class="hash-link" aria-label="Direct link to Advanced Rootless Configuration" title="Direct link to Advanced Rootless Configuration">​</a></h3><p>Rootless K3s uses <a href="https://github.com/rootless-containers/rootlesskit" target="_blank" rel="noopener noreferrer">rootlesskit</a> and <a href="https://github.com/rootless-containers/slirp4netns" target="_blank" rel="noopener noreferrer">slirp4netns</a> to communicate between host and user network namespaces.
Some of the configuration used by rootlesskit and slirp4nets can be set by environment variables. The best way to set these is to add them to the <code>Environment</code> field of the k3s-rootless systemd unit.</p><table><thead><tr><th>Variable</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code>K3S_ROOTLESS_MTU</code></td><td>1500</td><td>Sets the MTU for the slirp4netns virtual interfaces.</td></tr><tr><td><code>K3S_ROOTLESS_CIDR</code></td><td>10.41.0.0/16</td><td>Sets the CIDR used by slirp4netns virtual interfaces.</td></tr><tr><td><code>K3S_ROOTLESS_ENABLE_IPV6</code></td><td>autotedected</td><td>Enables slirp4netns IPv6 support. If not specified, it is automatically enabled if K3s is configured for dual-stack operation.</td></tr><tr><td><code>K3S_ROOTLESS_PORT_DRIVER</code></td><td>builtin</td><td>Selects the rootless port driver; either <code>builtin</code> or <code>slirp4netns</code>. Builtin is faster, but masquerades the original source address of inbound packets.</td></tr><tr><td><code>K3S_ROOTLESS_DISABLE_HOST_LOOPBACK</code></td><td>true</td><td>Controls whether or not access to the hosts&#x27;s loopback address via the gateway interface is enabled. It is recommended that this not be changed, for security reasons.</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting-rootless">Troubleshooting Rootless<a href="#troubleshooting-rootless" class="hash-link" aria-label="Direct link to Troubleshooting Rootless" title="Direct link to Troubleshooting Rootless">​</a></h3><ul><li>Run <code>systemctl --user status k3s-rootless</code> to check the daemon status</li><li>Run <code>journalctl --user -f -u k3s-rootless</code> to see the daemon log</li><li>See also <a href="https://rootlesscontaine.rs/" target="_blank" rel="noopener noreferrer">https://rootlesscontaine.rs/</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="node-labels-and-taints">Node Labels and Taints<a href="#node-labels-and-taints" class="hash-link" aria-label="Direct link to Node Labels and Taints" title="Direct link to Node Labels and Taints">​</a></h2><p>K3s agents can be configured with the options <code>--node-label</code> and <code>--node-taint</code> which adds a label and taint to the kubelet. The two options only add labels and/or taints <a href="/docs-k3s/cli/agent#node-labels-and-taints-for-agents">at registration time</a>, so they can only be set when the node is first joined to the cluster.</p><p>All current versions of Kubernetes restrict nodes from registering with most labels with <code>kubernetes.io</code> and <code>k8s.io</code> prefixes, specifically including the <code>kubernetes.io/role</code> label. If you attempt to start a node with a disallowed label, K3s will fail to start. As stated by the Kubernetes authors:</p><blockquote><p>Nodes are not permitted to assert their own role labels. Node roles are typically used to identify privileged or control plane types of nodes, and allowing nodes to label themselves into that pool allows a compromised node to trivially attract workloads (like control plane daemonsets) that confer access to higher privilege credentials.</p></blockquote><p>See <a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-auth/279-limit-node-access/README.md#proposal" target="_blank" rel="noopener noreferrer">SIG-Auth KEP 279</a> for more information.</p><p>If you want to change node labels and taints after node registration, or add reserved labels, you should use <code>kubectl</code>. Refer to the official Kubernetes documentation for details on how to add <a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/" target="_blank" rel="noopener noreferrer">taints</a> and <a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#add-a-label-to-a-node" target="_blank" rel="noopener noreferrer">node labels.</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="starting-the-service-with-the-installation-script">Starting the Service with the Installation Script<a href="#starting-the-service-with-the-installation-script" class="hash-link" aria-label="Direct link to Starting the Service with the Installation Script" title="Direct link to Starting the Service with the Installation Script">​</a></h2><p>The installation script will auto-detect if your OS is using systemd or openrc and enable and start the service as part of the installation process.</p><ul><li>When running with openrc, logs will be created at <code>/var/log/k3s.log</code>. </li><li>When running with systemd, logs will be created in <code>/var/log/syslog</code> and viewed using <code>journalctl -u k3s</code> (or <code>journalctl -u k3s-agent</code> on agents).</li></ul><p>An example of disabling auto-starting and service enablement with the install script:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> -sfL https://get.k3s.io </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">INSTALL_K3S_SKIP_START</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">true </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">INSTALL_K3S_SKIP_ENABLE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">true </span><span class="token function" style="color:rgb(130, 170, 255)">sh</span><span class="token plain"> -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-os-preparations">Additional OS Preparations<a href="#additional-os-preparations" class="hash-link" aria-label="Direct link to Additional OS Preparations" title="Direct link to Additional OS Preparations">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="old-iptables-versions">Old iptables versions<a href="#old-iptables-versions" class="hash-link" aria-label="Direct link to Old iptables versions" title="Direct link to Old iptables versions">​</a></h3><p>Several popular Linux distributions ship a version of iptables that contain a bug which causes the accumulation of duplicate rules, which negatively affects the performance and stability of the node. See <a href="https://github.com/k3s-io/k3s/issues/3117" target="_blank" rel="noopener noreferrer">Issue #3117</a> for information on how to determine if you are affected by this problem.</p><p>K3s includes a working version of iptables (v1.8.8) which functions properly. You can tell K3s to use its bundled version of iptables by starting K3s with the <code>--prefer-bundled-bin</code> option, or by uninstalling the iptables/nftables packages from your operating system.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Version Gate</div><div class="admonitionContent_S0QG"><p>The <code>--prefer-bundled-bin</code> flag is available starting with the 2022-12 releases (v1.26.0+k3s1, v1.25.5+k3s1, v1.24.9+k3s1, v1.23.15+k3s1).</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="red-hat-enterprise-linux--centos">Red Hat Enterprise Linux / CentOS<a href="#red-hat-enterprise-linux--centos" class="hash-link" aria-label="Direct link to Red Hat Enterprise Linux / CentOS" title="Direct link to Red Hat Enterprise Linux / CentOS">​</a></h3><p>It is recommended to turn off firewalld:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl disable firewalld --now</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you wish to keep firewalld enabled, by default, the following rules are required:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">firewall-cmd --permanent --add-port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">6443</span><span class="token plain">/tcp </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#apiserver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">firewall-cmd --permanent --zone</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">trusted --add-source</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10.42</span><span class="token plain">.0.0/16 </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#pods</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">firewall-cmd --permanent --zone</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">trusted --add-source</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10.43</span><span class="token plain">.0.0/16 </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#services</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">firewall-cmd --reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Additional ports may need to be opened depending on your setup. See <a href="/docs-k3s/installation/requirements#inbound-rules-for-k3s-server-nodes">Inbound Rules</a> for more information. If you change the default CIDR for pods or services, you will need to update the firewall rules accordingly.</p><p>If enabled, it is required to disable nm-cloud-setup and reboot the node:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl disable nm-cloud-setup.service nm-cloud-setup.timer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">reboot</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ubuntu">Ubuntu<a href="#ubuntu" class="hash-link" aria-label="Direct link to Ubuntu" title="Direct link to Ubuntu">​</a></h3><p>It is recommended to turn off ufw (uncomplicated firewall):</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ufw disable</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you wish to keep ufw enabled, by default, the following rules are required:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ufw allow </span><span class="token number" style="color:rgb(247, 140, 108)">6443</span><span class="token plain">/tcp </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#apiserver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ufw allow from </span><span class="token number" style="color:rgb(247, 140, 108)">10.42</span><span class="token plain">.0.0/16 to any </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#pods</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ufw allow from </span><span class="token number" style="color:rgb(247, 140, 108)">10.43</span><span class="token plain">.0.0/16 to any </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#services</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Additional ports may need to be opened depending on your setup. See <a href="/docs-k3s/installation/requirements#inbound-rules-for-k3s-server-nodes">Inbound Rules</a> for more information. If you change the default CIDR for pods or services, you will need to update the firewall rules accordingly.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="raspberry-pi">Raspberry Pi<a href="#raspberry-pi" class="hash-link" aria-label="Direct link to Raspberry Pi" title="Direct link to Raspberry Pi">​</a></h3><p>Raspberry Pi OS is Debian based, and may suffer from an old iptables version. See <a href="#old-iptables-versions">workarounds</a>.</p><p>Standard Raspberry Pi OS installations do not start with <code>cgroups</code> enabled. <strong>K3S</strong> needs <code>cgroups</code> to start the systemd service. <code>cgroups</code>can be enabled by appending <code>cgroup_memory=1 cgroup_enable=memory</code> to <code>/boot/cmdline.txt</code>.</p><p>Example cmdline.txt:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">console=serial0,115200 console=tty1 root=PARTUUID=58b06195-02 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait cgroup_memory=1 cgroup_enable=memory</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Starting with Ubuntu 21.10, vxlan support on Raspberry Pi has been moved into a separate kernel module. </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">apt</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> linux-modules-extra-raspi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-k3s-in-docker">Running K3s in Docker<a href="#running-k3s-in-docker" class="hash-link" aria-label="Direct link to Running K3s in Docker" title="Direct link to Running K3s in Docker">​</a></h2><p>There are several ways to run K3s in Docker:</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">K3d</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Docker</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p><a href="https://github.com/k3d-io/k3d" target="_blank" rel="noopener noreferrer">k3d</a> is a utility designed to easily run multi-node K3s clusters in Docker.</p><p>k3d makes it very easy to create single- and multi-node k3s clusters in docker, e.g. for local development on Kubernetes.</p><p>See the <a href="https://k3d.io/#installation" target="_blank" rel="noopener noreferrer">Installation</a> documentation for more information on how to install and use k3d.</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>To use Docker, <code>rancher/k3s</code> images are also available to run the K3s server and agent.
Using the <code>docker run</code> command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> run </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --privileged </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --name k3s-server-1 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --hostname k3s-server-1 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -p </span><span class="token number" style="color:rgb(247, 140, 108)">6443</span><span class="token plain">:6443 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -d rancher/k3s:v1.24.10-k3s1 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>You must specify a valid K3s version as the tag; the <code>latest</code> tag is not maintained.<br>
<!-- -->Docker images do not allow a <code>+</code> sign in tags, use a <code>-</code> in the tag instead.</p></div></div><p>Once K3s is up and running, you can copy the admin kubeconfig out of the Docker container for use:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> k3s-server-1:/etc/rancher/k3s/k3s.yaml ~/.kube/config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="selinux-support">SELinux Support<a href="#selinux-support" class="hash-link" aria-label="Direct link to SELinux Support" title="Direct link to SELinux Support">​</a></h2><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Version Gate</div><div class="admonitionContent_S0QG"><p>Available as of v1.19.4+k3s1</p></div></div><p>If you are installing K3s on a system where SELinux is enabled by default (such as CentOS), you must ensure the proper SELinux policies have been installed. </p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Automatic Installation</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Manual Installation</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p>The <a href="/docs-k3s/installation/configuration#configuration-with-install-script">install script</a> will automatically install the SELinux RPM from the Rancher RPM repository if on a compatible system if not performing an air-gapped install. Automatic installation can be skipped by setting <code>INSTALL_K3S_SKIP_SELINUX_RPM=true</code>.</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>The necessary policies can be installed with the following commands:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">yum </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> -y container-selinux selinux-policy-base</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">yum </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> -y https://rpm.rancher.io/k3s/latest/common/centos/7/noarch/k3s-selinux-0.2-1.el7_8.noarch.rpm</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To force the install script to log a warning rather than fail, you can set the following environment variable: <code>INSTALL_K3S_SELINUX_WARN=true</code>.</p></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="enabling-selinux-enforcement">Enabling SELinux Enforcement<a href="#enabling-selinux-enforcement" class="hash-link" aria-label="Direct link to Enabling SELinux Enforcement" title="Direct link to Enabling SELinux Enforcement">​</a></h3><p>To leverage SELinux, specify the <code>--selinux</code> flag when starting K3s servers and agents.</p><p>This option can also be specified in the K3s <a href="#">configuration file</a>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">selinux: true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Using a custom <code>--data-dir</code> under SELinux is not supported. To customize it, you would most likely need to write your own custom policy. For guidance, you could refer to the <a href="https://github.com/containers/container-selinux" target="_blank" rel="noopener noreferrer">containers/container-selinux</a> repository, which contains the SELinux policy files for Container Runtimes, and the <a href="https://github.com/k3s-io/k3s-selinux" target="_blank" rel="noopener noreferrer">k3s-io/k3s-selinux</a> repository, which contains the SELinux policy for K3s.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="enabling-lazy-pulling-of-estargz-experimental">Enabling Lazy Pulling of eStargz (Experimental)<a href="#enabling-lazy-pulling-of-estargz-experimental" class="hash-link" aria-label="Direct link to Enabling Lazy Pulling of eStargz (Experimental)" title="Direct link to Enabling Lazy Pulling of eStargz (Experimental)">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="whats-lazy-pulling-and-estargz">What&#x27;s lazy pulling and eStargz?<a href="#whats-lazy-pulling-and-estargz" class="hash-link" aria-label="Direct link to What&#x27;s lazy pulling and eStargz?" title="Direct link to What&#x27;s lazy pulling and eStargz?">​</a></h3><p>Pulling images is known as one of the time-consuming steps in the container lifecycle.
According to <a href="https://www.usenix.org/conference/fast16/technical-sessions/presentation/harter" target="_blank" rel="noopener noreferrer">Harter, et al.</a>,</p><blockquote><p>pulling packages accounts for 76% of container start time, but only 6.4% of that data is read</p></blockquote><p>To address this issue, k3s experimentally supports <em>lazy pulling</em> of image contents.
This allows k3s to start a container before the entire image has been pulled.
Instead, the necessary chunks of contents (e.g. individual files) are fetched on-demand.
Especially for large images, this technique can shorten the container startup latency.</p><p>To enable lazy pulling, the target image needs to be formatted as <a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/stargz-estargz.md" target="_blank" rel="noopener noreferrer"><em>eStargz</em></a>.
This is an OCI-alternative but 100% OCI-compatible image format for lazy pulling.
Because of the compatibility, eStargz can be pushed to standard container registries (e.g. ghcr.io) as well as this is <em>still runnable</em> even on eStargz-agnostic runtimes.</p><p>eStargz is developed based on the <a href="https://github.com/google/crfs" target="_blank" rel="noopener noreferrer">stargz format proposed by Google CRFS project</a> but comes with practical features including content verification and performance optimization.
For more details about lazy pulling and eStargz, please refer to <a href="https://github.com/containerd/stargz-snapshotter" target="_blank" rel="noopener noreferrer">Stargz Snapshotter project repository</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-k3s-for-lazy-pulling-of-estargz">Configure k3s for lazy pulling of eStargz<a href="#configure-k3s-for-lazy-pulling-of-estargz" class="hash-link" aria-label="Direct link to Configure k3s for lazy pulling of eStargz" title="Direct link to Configure k3s for lazy pulling of eStargz">​</a></h3><p>As shown in the following, <code>--snapshotter=stargz</code> option is needed for k3s server and agent.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">k3s server --snapshotter</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">stargz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With this configuration, you can perform lazy pulling for eStargz-formatted images.
The following example Pod manifest uses eStargz-formatted <code>node:13.13.0</code> image (<code>ghcr.io/stargz-containers/node:13.13.0-esgz</code>).
When the stargz snapshotter is enabled, K3s performs lazy pulling for this image.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nodejs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nodejs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">estargz</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ghcr.io/stargz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">containers/node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">13.13.0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">esgz</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">e</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> var http = require(&#x27;http&#x27;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      http.createServer(function(req</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> res) </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        res.writeHead(200);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        res.end(&#x27;Hello World</span><span class="token tag" style="color:rgb(255, 85, 114)">!</span><span class="token plain">\n&#x27;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">).listen(80);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-logging-sources">Additional Logging Sources<a href="#additional-logging-sources" class="hash-link" aria-label="Direct link to Additional Logging Sources" title="Direct link to Additional Logging Sources">​</a></h2><p><a href="https://rancher.com/docs/rancher/v2.6/en/logging/helm-chart-options/" target="_blank" rel="noopener noreferrer">Rancher logging</a> for K3s can be installed without using Rancher. The following instructions should be executed to do so:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm repo </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> rancher-charts https://charts.rancher.io</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> --create-namespace -n cattle-logging-system rancher-logging-crd rancher-charts/rancher-logging-crd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> --create-namespace -n cattle-logging-system rancher-logging --set additionalLoggingSources.k3s.enabled</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">true rancher-charts/rancher-logging</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-network-policy-logging">Additional Network Policy Logging<a href="#additional-network-policy-logging" class="hash-link" aria-label="Direct link to Additional Network Policy Logging" title="Direct link to Additional Network Policy Logging">​</a></h2><p>Packets dropped by network policies can be logged. The packet is sent to the iptables NFLOG action, which shows the packet details, including the network policy that blocked it.</p><p>If there is a lot of traffic, the number of log messages could be very high. To control the log rate on a per-policy basis, set the <code>limit</code> and <code>limit-burst</code> iptables parameters by adding the following annotations to the network policy in question:</p><ul><li><code>kube-router.io/netpol-nflog-limit=&lt;LIMIT-VALUE&gt;</code></li><li><code>kube-router.io/netpol-nflog-limit-burst=&lt;LIMIT-BURST-VALUE&gt;</code></li></ul><p>Default values are <code>limit=10/minute</code> and <code>limit-burst=10</code>. Check the <a href="https://www.netfilter.org/documentation/HOWTO/packet-filtering-HOWTO-7.html#:~:text=restrict%20the%20rate%20of%20matches" target="_blank" rel="noopener noreferrer">iptables manual</a> for more information on the format and possible values for these fields.</p><p>To convert NFLOG packets to log entries, install ulogd2 and configure <code>[log1]</code> to read on <code>group=100</code>. Then, restart the ulogd2 service for the new config to be committed.
When a packet is blocked by network policy rules, a log message will appear in <code>/var/log/ulog/syslogemu.log</code>.</p><p>Packets sent to the NFLOG netlink socket can also be read by using command-line tools like tcpdump or tshark:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">tcpdump -ni nflog:100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>While more readily available, tcpdump will not show the name of the network policy that blocked the packet. Use wireshark&#x27;s tshark command instead to display the full NFLOG packet header, including the <code>nflog.prefix</code> field that contains the policy name.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/k3s-io/docs/edit/main/docs/advanced/advanced.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-08-28T18:51:07.000Z">Aug 28, 2023</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs-k3s/helm"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Helm</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs-k3s/faq"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">FAQ</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#certificate-management" class="table-of-contents__link toc-highlight">Certificate Management</a><ul><li><a href="#certificate-authority-certificates" class="table-of-contents__link toc-highlight">Certificate Authority Certificates</a></li><li><a href="#client-and-server-certificates" class="table-of-contents__link toc-highlight">Client and Server certificates</a></li></ul></li><li><a href="#token-management" class="table-of-contents__link toc-highlight">Token Management</a></li><li><a href="#configuring-an-http-proxy" class="table-of-contents__link toc-highlight">Configuring an HTTP proxy</a></li><li><a href="#using-docker-as-the-container-runtime" class="table-of-contents__link toc-highlight">Using Docker as the Container Runtime</a></li><li><a href="#using-etcdctl" class="table-of-contents__link toc-highlight">Using etcdctl</a></li><li><a href="#configuring-containerd" class="table-of-contents__link toc-highlight">Configuring containerd</a></li><li><a href="#nvidia-container-runtime-support" class="table-of-contents__link toc-highlight">NVIDIA Container Runtime Support</a></li><li><a href="#running-agentless-servers-experimental" class="table-of-contents__link toc-highlight">Running Agentless Servers (Experimental)</a></li><li><a href="#running-rootless-servers-experimental" class="table-of-contents__link toc-highlight">Running Rootless Servers (Experimental)</a><ul><li><a href="#known-issues-with-rootless-mode" class="table-of-contents__link toc-highlight">Known Issues with Rootless mode</a></li><li><a href="#starting-rootless-servers" class="table-of-contents__link toc-highlight">Starting Rootless Servers</a></li><li><a href="#advanced-rootless-configuration" class="table-of-contents__link toc-highlight">Advanced Rootless Configuration</a></li><li><a href="#troubleshooting-rootless" class="table-of-contents__link toc-highlight">Troubleshooting Rootless</a></li></ul></li><li><a href="#node-labels-and-taints" class="table-of-contents__link toc-highlight">Node Labels and Taints</a></li><li><a href="#starting-the-service-with-the-installation-script" class="table-of-contents__link toc-highlight">Starting the Service with the Installation Script</a></li><li><a href="#additional-os-preparations" class="table-of-contents__link toc-highlight">Additional OS Preparations</a><ul><li><a href="#old-iptables-versions" class="table-of-contents__link toc-highlight">Old iptables versions</a></li><li><a href="#red-hat-enterprise-linux--centos" class="table-of-contents__link toc-highlight">Red Hat Enterprise Linux / CentOS</a></li><li><a href="#ubuntu" class="table-of-contents__link toc-highlight">Ubuntu</a></li><li><a href="#raspberry-pi" class="table-of-contents__link toc-highlight">Raspberry Pi</a></li></ul></li><li><a href="#running-k3s-in-docker" class="table-of-contents__link toc-highlight">Running K3s in Docker</a></li><li><a href="#selinux-support" class="table-of-contents__link toc-highlight">SELinux Support</a><ul><li><a href="#enabling-selinux-enforcement" class="table-of-contents__link toc-highlight">Enabling SELinux Enforcement</a></li></ul></li><li><a href="#enabling-lazy-pulling-of-estargz-experimental" class="table-of-contents__link toc-highlight">Enabling Lazy Pulling of eStargz (Experimental)</a><ul><li><a href="#whats-lazy-pulling-and-estargz" class="table-of-contents__link toc-highlight">What&#39;s lazy pulling and eStargz?</a></li><li><a href="#configure-k3s-for-lazy-pulling-of-estargz" class="table-of-contents__link toc-highlight">Configure k3s for lazy pulling of eStargz</a></li></ul></li><li><a href="#additional-logging-sources" class="table-of-contents__link toc-highlight">Additional Logging Sources</a></li><li><a href="#additional-network-policy-logging" class="table-of-contents__link toc-highlight">Additional Network Policy Logging</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 K3s Project Authors. All rights reserved. <br>The Linux Foundation has registered trademarks
      and uses trademarks. For a list of trademarks of The Linux Foundation, 
      please see our <a href="https://www.linuxfoundation.org/trademark-usage"> Trademark Usage</a> page.</div></div></div></footer></div>
<script src="/docs-k3s/assets/js/runtime~main.e1810fa2.js"></script>
<script src="/docs-k3s/assets/js/main.3e014df7.js"></script>
</body>
</html>